# Теоретический анализ проекта: Система мониторинга и анализа водных каналов

## 1. Общая архитектура проекта

### 1.1. Назначение системы
Проект представляет собой веб-приложение для мониторинга, анализа и управления ирригационными каналами в Таджикистане. Система предназначена для специалистов водного хозяйства и позволяет:
- Визуализировать каналы на интерактивной карте
- Автоматически рассчитывать потери воды
- Анализировать данные через искусственный интеллект
- Генерировать отчеты на двух языках (русский и таджикский)

### 1.2. Технологический стек
- **Frontend**: React 19, TypeScript, Vite
- **UI библиотеки**: Ant Design, Shadcn UI, Radix UI
- **Картография**: 2GIS MapGL API, Leaflet
- **Визуализация данных**: Recharts
- **Интернационализация**: i18next (русский, таджикский)
- **ИИ анализ**: OpenAI API (GPT-4o-mini) через прокси

## 2. Автоматический подсчет данных таблицы 14 из таблицы 16

### 2.1. Источник данных: Таблица 16 (Давоми ҷадвали 16)

Таблица 16 содержит данные о расходе воды в каналах по декадам для месяцев с апреля по октябрь. Данные структурированы следующим образом:

**Структура таблицы 16:**
- **Часть 1** (Апрель-Июнь): Каналы группы пользователей воды
  - Содержит колонку Ω (коэффициент)
  - 5 каналов: 1-МК, 1-1К, 1-2К, 1-3К, 1-4К
  
- **Часть 2** (Июль-Октябрь): Каналы АИО (Ассоциации водопользователей)
  - Без колонки Ω
  - Те же 5 каналов

**Данные по декадам:**
- Каждый месяц разбит на 3 декады (I, II, III)
- Октябрь имеет только 2 декады (I, II)
- Значения представлены в л/с (литры в секунду)

### 2.2. Автоматический расчет таблицы 14 (Давоми ҷадвали 14)

Таблица 14 рассчитывается автоматически на основе данных таблицы 16. Процесс расчета включает следующие этапы:

#### 2.2.1. Математические формулы

**Формула потерь воды (S):**
```
S = 10 × A × L × √(Qвх / 1000)
```
где:
- **S** - потери воды (л/с)
- **A** - коэффициент фильтрации (среднее значение: 2.08)
- **L** - длина участка канала (км)
- **Qвх** - входящий расход воды (л/с)

**Формула исходящего расхода:**
```
Qfx = Qвх + S
```

**Формула объема водозабора:**
```
Wг = 86.4 × t × Qг / 10⁶
```
где:
- **Wг** - объем водозабора (млн. м³)
- **t** - количество дней в декаде (10 дней)
- **Qг** - общий расход (л/с)

#### 2.2.2. Алгоритм расчета

**Строка 1: Участок 1-1МК ПК90+50 ПК60+20 (длина: 3.030 км)**
1. Qвх = Q(1-4К) - берется из таблицы 16, строка "1-4К, АИО - 4"
2. S = 10 × A × 3.030 × √(Qвх / 1000)
3. Qfx = Qвх + S

**Строка 2: Участок 1-1MK ПК60+20 – ПК00+00 (длина: 6.020 км)**
1. Qвх = Qfx строки 1 + Q(1-2К) + Q(1-3К)
   - Q(1-2К) берется из таблицы 16, строка "1-2К, АИО - 2"
   - Q(1-3К) берется из таблицы 16, строка "1-3К, АИО - 3"
2. S = 10 × A × 6.020 × √(Qвх / 1000)
3. Qfx = Qвх + S

**Строка 3: Участок 1-1МК1 ПК134+70 – ПК74+40 (длина: 6.030 км)**
1. Qвх = Qfx строки 2 + Q(1-3К)
2. S = 10 × A × 6.030 × √(Qвх / 1000)
3. Qfx = Qвх + S

**Строка 4: Участок 1-1МК1 ПК74+40 – ПК00+00 (длина: 0.744 км)**
1. Qвх = Qfx строки 3
2. S = 10 × A × 0.744 × √(Qвх / 1000)
3. Qfx = Qвх + S

**Строка 5: Общий расход водозабора**
- Qг = Qfx строки 4

**Строка 6: Объем водозабора**
- Wг = 86.4 × 10 × Qг / 10⁶

**Строка 7: Общий объем водозабора**
- Wобщ = Wг + Wвн (где Wвн = 0 - объем возвратных вод)

#### 2.2.3. Особенности реализации

1. **Автоматический пересчет**: При изменении данных в таблице 16, таблица 14 пересчитывается автоматически через функцию `calculateHydrologyTable()`

2. **Обработка пустых значений**: 
   - Если данные отсутствуют (null), расчет для соответствующей декады пропускается
   - Для октября учитывается только 2 декады вместо 3

3. **Период расчета**: 
   - Расчеты выполняются для месяцев: Август, Сентябрь, Октябрь
   - Для Июля строки 2-7 остаются пустыми (по спецификации)

4. **Интеграция с API** (теоретическая):
   - В текущей реализации данные статичны (хранятся в `data.ts`)
   - В будущем данные таблицы 16 могут поступать из внешнего API
   - Система готова к интеграции: функция `calculateHydrologyTable()` принимает массив данных, который может быть получен из API

## 3. ИИ-анализ данных

### 3.1. Архитектура ИИ-анализа

Система использует OpenAI API (GPT-4o-mini) для интеллектуального анализа данных о каналах. Анализ выполняется в двух контекстах:

1. **Анализ отдельного канала** (`analyzeChannel`)
2. **Анализ таблицы 14** (`analyzeTable14`)

### 3.2. Процесс анализа

#### 3.2.1. Подготовка данных

Перед отправкой в ИИ система:
- Собирает все необходимые метрики канала
- Рассчитывает средние значения потерь для каждого участка
- Формирует структурированный промпт на соответствующем языке

#### 3.2.2. Промпт для ИИ

ИИ получает детальное описание:
- Название канала и его характеристики
- Геометрические параметры (длина, ширина, глубина)
- Гидрологические данные (расход, объемы, потери)
- Процентные показатели (потери, КПД)
- Статус канала (норма, высокие потери, критический)

**Задачи для ИИ:**
1. Детальный анализ текущего состояния канала
2. Выявление причин потерь воды:
   - Фильтрация через стенки и дно канала
   - Испарение с поверхности воды
   - Утечки через повреждения
   - Другие факторы
3. Конкретные рекомендации по улучшению:
   - Бетонирование канала
   - Ремонт поврежденных участков
   - Оптимизация эксплуатации
   - Профилактические меры
4. Определение приоритета действий (low, medium, high, critical)
5. Оценка эффективности предлагаемых мер

#### 3.2.3. Учет природных факторов

ИИ учитывает, что **испарение воды является природным явлением**, которое невозможно контролировать на 100%. В анализе:

- **Испарение** признается как естественный процесс, зависящий от:
  - Температуры воздуха
  - Влажности
  - Скорости ветра
  - Площади поверхности воды
  - Интенсивности солнечного излучения

- **Минимизация испарения** возможна через:
  - Сокращение площади открытой водной поверхности
  - Использование покрытий (пленки, навесы)
  - Оптимизация режима работы канала
  - Выбор времени полива (ночные часы)

- **Контролируемые потери** (фильтрация, утечки) требуют:
  - Бетонирование каналов
  - Регулярный ремонт
  - Мониторинг состояния

### 3.3. Формат ответа ИИ

ИИ возвращает структурированный JSON:
```json
{
  "analysis": "детальный анализ текстом",
  "recommendations": [
    "рекомендация 1",
    "рекомендация 2",
    ...
  ],
  "priority": "low|medium|high|critical"
}
```

### 3.4. Многоязычность

Система поддерживает анализ на двух языках:

- **Русский язык** (`language = 'ru'`):
  - Промпт формируется на русском
  - Ответы ИИ на русском языке
  - Терминология адаптирована для специалистов водного хозяйства

- **Таджикский язык** (`language = 'tj'`):
  - Промпт формируется на таджикском
  - Ответы ИИ на таджикском языке
  - Используется профессиональная терминология на таджикском

**Определение языка:**
- Язык определяется автоматически на основе текущего языка интерфейса (`i18n.language`)
- Пользователь может переключать язык через компонент `LanguageSwitcher`

### 3.5. Определение приоритета

Система автоматически определяет приоритет на основе процента потерь:

- **Critical (Критический)**: потери > 30%
- **High (Высокий)**: потери > 15%
- **Medium (Средний)**: потери > 5%
- **Low (Низкий)**: потери ≤ 5%

## 4. Визуализация данных

### 4.1. Интерактивная карта

Система использует две картографические библиотеки:

1. **2GIS MapGL** (основная):
   - Высокое качество карт для Таджикистана
   - Отображение каналов в виде линий
   - Интерактивные маркеры и попапы
   - Масштабирование и навигация

2. **Leaflet** (резервная):
   - Открытая библиотека
   - Поддержка различных провайдеров карт

**Функциональность карты:**
- Отображение всех каналов из базы данных
- Выделение выбранного канала
- Показ информации о канале при клике
- Автоматическое масштабирование для просмотра всех каналов

### 4.2. Графики и диаграммы

Система генерирует интерактивные графики с использованием библиотеки Recharts:

**Графики таблицы 16:**
- Линейные графики расхода воды по декадам
- Отдельные линии для каждого канала
- Период: Апрель-Июнь (часть 1) и Июль-Октябрь (часть 2)

**Графики таблицы 14:**
- Динамика Qfx (исходящий расход) по участкам
- Динамика Qг (общий расход)
- Динамика Wг (объем водозабора)
- Период: Август, Сентябрь, Октябрь

**Функциональность графиков:**
- Интерактивные подсказки при наведении
- Легенда для идентификации линий
- Адаптивный дизайн для разных размеров экрана

## 5. Интеграция компонентов

### 5.1. Поток данных

```
Таблица 16 (Давоми ҷадвали 16)
    ↓
Автоматический расчет (calculateHydrologyTable)
    ↓
Таблица 14 (Давоми ҷадвали 14)
    ↓
ИИ-анализ (analyzeTable14)
    ↓
Результаты анализа (DeepSeekAnalysis)
    ↓
Отображение пользователю
```

### 5.2. Компоненты системы

1. **OfficialData** - основной компонент для работы с таблицами
2. **AIAnalysis** - компонент для анализа отдельных каналов
3. **Map** - компонент карты с каналами
4. **ChannelsTable** - таблица со списком каналов
5. **ChannelsChart** - графики каналов
6. **WaterLossCalculator** - калькулятор потерь воды

## 6. Будущие улучшения (теоретические)

### 6.1. Интеграция с API

**Текущее состояние:**
- Данные таблицы 16 хранятся статически в `data.ts`

**Планируемое:**
- Получение данных таблицы 16 из внешнего API
- Автоматическое обновление данных в реальном времени
- Синхронизация с базами данных водного хозяйства

**Реализация:**
```typescript
// Пример будущей интеграции
async function fetchTable16Data(): Promise<Table16Part2Row[]> {
  const response = await fetch('/api/table16');
  return response.json();
}

// В компоненте
const table16Data = await fetchTable16Data();
const calculatedData = calculateHydrologyTable(table16Data);
```

### 6.2. Расширенный ИИ-анализ

**Возможные улучшения:**
- Анализ исторических данных для выявления трендов
- Прогнозирование потерь на основе метеорологических данных
- Сравнительный анализ с эталонными значениями
- Рекомендации по оптимальному режиму работы каналов

### 6.3. Уведомления и алерты

- Автоматические уведомления при критических потерях
- Email/SMS оповещения для ответственных лиц
- История изменений и событий

## 7. Заключение

Проект представляет собой комплексную систему для мониторинга и анализа ирригационных каналов, которая:

1. **Автоматизирует расчеты** потерь воды на основе стандартных формул
2. **Использует ИИ** для интеллектуального анализа и рекомендаций
3. **Поддерживает многоязычность** для работы в Таджикистане
4. **Визуализирует данные** через карты и графики
5. **Готова к масштабированию** через интеграцию с внешними API

Система учитывает специфику водного хозяйства Таджикистана и предоставляет практические инструменты для специалистов по управлению водными ресурсами.

